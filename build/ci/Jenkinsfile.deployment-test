@Library('nalej-helpers@feature/NP-490_ci_deploy_for_integration_tests')

String packageName = "scylla-deploy"
String appsList = "scylla"
String packagePath = "src/github.com/nalej/" + packageName
String yamlPath = packagePath + "/bin/yaml/mngtcluster"
String[] yamlList = [
    "scylla-configmap.yaml",
    "scylla-statefulset.yaml",
    "scylla-service.yaml"
]

def nsHelper = new org.daisho.k8s.Namespace()

pipeline {
    agent { node { label 'k8s' } }
    options {
        checkoutToSubdirectory("${packagePath}")
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage("Create namespace") {
            steps { container("kubectl") { 
                script {
                    env.namespaceName = nsHelper.createRandomNamespace()
                }
            } }
        }
        stage("Launch scylla deploy pipeline") {
            steps { 
                build job: 'k8s-namespace-test', parameters: [[$class: 'StringParameterValue', name: 'namespace', value: env.namespaceName]]
            }
        }
    }
    post {
        alwaysÂ {
            script {
                nsHelper.deleteNamespace(env.namespaceName)
            }
        }
    }
}
